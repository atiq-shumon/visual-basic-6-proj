
--====GRA_OPENING_CLOSING_SAVE
CREATE OR REPLACE  PROCEDURE GRA_OPENING_CLOSING_SAVE 

AS 

var_temp number;
V_OPEN_BALANCE NUMBER:=0;
V_MAX_BEGIN_DATE DATE;
V_MAX_END_DATE DATE;
V_TOTAL_RECEIVED_AMOUNT NUMBER:=0;
V_TOTAL_PAYMENT_AMOUNT NUMBER:=0;
V_CLOSING_BALANCE NUMBER:=0;
V_TRACK_ID NUMBER:=0;
V_ID NUMBER:=0;

cursor TRACK_ID_CURSOR is 
         select distinct(TRACK_ID) 
           from GRA_OPENING_CLOSING;

begin
OPEN TRACK_ID_CURSOR;

SELECT SUM(AMOUNT) INTO V_OPEN_BALANCE
FROM 
GRA_CAPITAL_FUND;


SELECT  
MAX(BEGIN_DATE) INTO V_MAX_BEGIN_DATE 
FROM 
FISCAL_YEAR_SETUP;

SELECT  
MAX(END_DATE) INTO V_MAX_END_DATE  
FROM 
FISCAL_YEAR_SETUP;


SELECT 
SUM(NVL(RECEIVED_AMOUNT,0)) INTO V_TOTAL_RECEIVED_AMOUNT 
FROM 
GRATUITY_RECEIVE
WHERE 
PAYMENT_RECE_DATE BETWEEN V_MAX_BEGIN_DATE AND V_MAX_END_DATE;

SELECT 
SUM(NVL(AMOUNT,0)) INTO V_TOTAL_PAYMENT_AMOUNT 
FROM 
GRATUITY_PAYMENT
WHERE 
PAYMENT_DATE BETWEEN V_MAX_BEGIN_DATE AND V_MAX_END_DATE;


V_CLOSING_BALANCE:=((V_OPEN_BALANCE + V_TOTAL_RECEIVED_AMOUNT) - V_TOTAL_PAYMENT_AMOUNT);

SELECT COUNT(*) INTO var_temp 
FROM 
GRA_OPENING_CLOSING 
WHERE 
DATE_CLOSING BETWEEN V_MAX_BEGIN_DATE AND V_MAX_END_DATE;

IF var_temp>0 THEN 


UPDATE GRA_OPENING_CLOSING 
SET 
CURRENT_YEAR_RECEIVE=V_TOTAL_RECEIVED_AMOUNT,
CURRENT_YEAR_PAYMENT=V_TOTAL_PAYMENT_AMOUNT,
CLOSING_BALANCE=V_CLOSING_BALANCE 
WHERE DATE_CLOSING BETWEEN V_MAX_BEGIN_DATE AND V_MAX_END_DATE;  
	
ELSE 

SELECT NVL(MAX(TRACK_ID),0) INTO V_ID 
FROM 
GRA_OPENING_CLOSING;

V_TRACK_ID:=V_ID + 1;

INSERT INTO GRA_OPENING_CLOSING VALUES(
	V_TRACK_ID,
	V_MAX_BEGIN_DATE,
	V_OPEN_BALANCE,
	V_TOTAL_RECEIVED_AMOUNT,
	V_TOTAL_PAYMENT_AMOUNT,
	V_CLOSING_BALANCE  
	);
END IF;
COMMIT;
end GRA_OPENING_CLOSING_SAVE;

/


--EXEC GRA_OPENING_CLOSING_SAVE




